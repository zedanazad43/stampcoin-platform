name: Security Check

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  security-check:
    name: Security Pre-deployment Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "Error: .env.example file not found!"
            exit 1
          fi
          echo ".env.example file found ✓"

      - name: Scan for hardcoded secrets
        run: |
          echo "Scanning for potential hardcoded secrets..."
          
          # Check for common secret patterns in source files
          # Exclude .env.example, docs, and test files
          
          found_issues=0
          
          # Check for API keys (but exclude .env.example and documentation)
          if grep -r -E "(api[_-]?key|secret[_-]?key|access[_-]?key|private[_-]?key)\s*=\s*['\"]?[a-zA-Z0-9]{20,}" \
            --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=.git \
            --exclude="*.test.*" --exclude="*.spec.*" --exclude=".env*" \
            . | grep -v "your_" | grep -v "example" | grep -v "placeholder" | grep -v "INSERT_"; then
            echo "⚠️  Warning: Possible hardcoded API keys found"
            found_issues=1
          fi
          
          # Check for AWS credentials
          if grep -r -E "AKIA[0-9A-Z]{16}" \
            --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=.git \
            .; then
            echo "⚠️  Warning: Possible AWS access key found"
            found_issues=1
          fi
          
          # Check for private keys
          if grep -r -E "-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----" \
            --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=.git \
            .; then
            echo "⚠️  Warning: Possible private key found"
            found_issues=1
          fi
          
          # Check for JWT tokens
          if grep -r -E "eyJ[a-zA-Z0-9_-]{10,}\.[a-zA-Z0-9_-]{10,}\.[a-zA-Z0-9_-]{10,}" \
            --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=.git \
            --exclude="*.test.*" --exclude="*.spec.*" \
            . | grep -v "example" | grep -v "mock"; then
            echo "⚠️  Warning: Possible JWT token found"
            found_issues=1
          fi
          
          if [ $found_issues -eq 0 ]; then
            echo "✓ No obvious secrets detected in source code"
          else
            echo ""
            echo "Please review the warnings above. If these are false positives (examples, tests, etc.), you can ignore them."
            echo "If they are real secrets, remove them and use environment variables instead."
            # Don't fail the workflow for warnings, just alert
          fi

      - name: Verify no secrets in git history (sample check)
        run: |
          echo "Checking recent commits for .env files..."
          if git log --all --pretty=format: --name-only --diff-filter=A | grep -E "^\.env$"; then
            echo "⚠️  Warning: .env file was committed in git history"
            echo "Consider using git-filter-repo or BFG Repo-Cleaner to remove it"
          else
            echo "✓ No .env file found in git history"
          fi

      - name: Security check complete
        run: echo "✓ Security check completed"
